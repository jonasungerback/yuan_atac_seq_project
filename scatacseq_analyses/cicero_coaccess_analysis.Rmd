---
title: "monocle_coaccess_analysis"
output: html_document
---

```{r setup, include=FALSE}
#So the idea here is to define enhancers with monocle, on the separate samples first and the merge them.
#Start with a non-ninary set of peaks.
library(SnapATAC)
#rm(list=setdiff(ls(), c("peak.dataframe", "x.sp3.monocle", "fluidigm_genes", "peak.gr")))

x.sp3.monocle <- x.sp3.sample_peaks

#Add back in a non-binary peak matrix:
rmPmatFromSnap(x.sp3.monocle)
#Create a cell-by-peak matrix
library(GenomicRanges) #Step below is dependent on Genomic Ranges.
x.sp3.monocle = createPmat(x.sp3.monocle, peak.gr,  do.par = TRUE, num.cores = 8)


load("/mnt/data/common/jonas/scatac/191204_yuan_FLvsBM_HSC_BHHTF7DRXX/snap_atac_analysis/base_analysis_downscaled/monocle_coaccess_analysis.RData")
#x.sp3.monocle = makeBinary(x.sp3.monocle, mat="pmat")

peak.matrix <- t (as(object = x.sp3.monocle@pmat, Class = 'matrix') )
colnames(peak.matrix) <- x.sp3.monocle@sample

peaks.df <- as.data.frame(peak.gr)[,1:3]

rownames(peak.matrix) <- paste(peaks.df[,1],peaks.df[,2],peaks.df[,3],sep = "_")

library(reshape2)
peaks.df <- as.data.frame( peak.matrix )
#table(colnames(peaks.df))
#CD41neg CD41pos  FL_HSC     MkP 
#   2310    1123    2403    2986

colnames(peaks.df)[1:2403] <- paste(colnames(peaks.df)[1:2403], 1:2403, sep = "-")   
colnames(peaks.df)[2404:4713] <- paste(colnames(peaks.df)[2404:4713], 1:2310, sep = "-")
colnames(peaks.df)[4714:5836] <- paste(colnames(peaks.df)[4714:5836], 1:1123, sep = "-")
colnames(peaks.df)[5837:8822] <- paste(colnames(peaks.df)[5837:8822], 1:2986, sep = "-")

#Split the matrices.
peaks.df.FL <- peaks.df[,1:2403]
peaks.df.CD41neg <-peaks.df[,2404:4713]
peaks.df.CD41pos <- peaks.df[,4714:5836]
peaks.df.MkP <- peaks.df[,5837:8822]

peaks.df.FL$peaks <- rownames(peak.matrix)
peaks.df.CD41neg$peaks <- rownames(peak.matrix)
peaks.df.CD41pos$peaks <- rownames(peak.matrix)
peaks.df.MkP$peaks <- rownames(peak.matrix)

peaks.df.FL <- melt(peaks.df.FL, id.var = c("peaks"))
peaks.df.CD41neg <- melt(peaks.df.CD41neg, id.var = c("peaks"))
peaks.df.CD41pos <- melt(peaks.df.CD41pos, id.var = c("peaks"))
peaks.df.MkP <- melt(peaks.df.MkP, id.var = c("peaks"))


#Save only columns with values > 0. Should be fine since the input should be sparse.

peaks.df.FL <- subset(peaks.df.FL, peaks.df.FL$value > 0)
peaks.df.CD41neg <- subset(peaks.df.CD41neg, peaks.df.CD41neg$value > 0)
peaks.df.CD41pos <- subset(peaks.df.CD41pos, peaks.df.CD41pos$value > 0)
peaks.df.MkP <- subset(peaks.df.MkP, peaks.df.MkP$value > 0)

#Make cicero objects.
library(cicero)
input_cds.FL <- make_atac_cds(peaks.df.FL, binarize = TRUE)
input_cds.CD41neg <- make_atac_cds(peaks.df.CD41neg, binarize = TRUE)
input_cds.CD41pos <- make_atac_cds(peaks.df.CD41pos, binarize = TRUE)
input_cds.MkP <- make_atac_cds(peaks.df.MkP, binarize = TRUE)

#Derive umap coordinates
#umap_coords.FL <- x.sp3.monocle@umap[1:2403,]
#umap_coords.CD41neg <- x.sp3.monocle@umap[2404:4713,]
#umap_coords.CD41pos <- x.sp3.monocle@umap[4714:5836,]
#umap_coords.MkP <- x.sp3.monocle@umap[5837:8822,]

#rownames(umap_coords.FL)<-colnames(input_cds.FL)
#rownames(umap_coords.CD41neg)<-colnames(input_cds.CD41neg)
#rownames(umap_coords.CD41pos)<-colnames(input_cds.CD41pos)
#rownames(umap_coords.MkP)<-colnames(input_cds.MkP)

#Calculate tsne for each individual sample
input_cds.FL <- detectGenes(input_cds.FL)
input_cds.FL <- estimateSizeFactors(input_cds.FL)
input_cds.FL <- reduceDimension(input_cds.FL, max_components = 2, num_dim=6,
                             reduction_method = 'tSNE', norm_method = "none")
tsne_coords.FL <- t(reducedDimA(input_cds.FL))
row.names(tsne_coords.FL) <- row.names(pData(input_cds.FL))

input_cds.CD41neg <- detectGenes(input_cds.CD41neg)
input_cds.CD41neg <- estimateSizeFactors(input_cds.CD41neg)
input_cds.CD41neg <- reduceDimension(input_cds.CD41neg, max_components = 2, num_dim=6,
                             reduction_method = 'tSNE', norm_method = "none")
tsne_coords.CD41neg <- t(reducedDimA(input_cds.CD41neg))
row.names(tsne_coords.CD41neg) <- row.names(pData(input_cds.CD41neg))

input_cds.CD41pos <- detectGenes(input_cds.CD41pos)
input_cds.CD41pos <- estimateSizeFactors(input_cds.CD41pos)
input_cds.CD41pos <- reduceDimension(input_cds.CD41pos, max_components = 2, num_dim=6,
                             reduction_method = 'tSNE', norm_method = "none")
tsne_coords.CD41pos <- t(reducedDimA(input_cds.CD41pos))
row.names(tsne_coords.CD41pos) <- row.names(pData(input_cds.CD41pos))

input_cds.MkP <- detectGenes(input_cds.MkP)
input_cds.MkP <- estimateSizeFactors(input_cds.MkP)
input_cds.MkP <- reduceDimension(input_cds.MkP, max_components = 2, num_dim=6,
                             reduction_method = 'tSNE', norm_method = "none")
tsne_coords.MkP <- t(reducedDimA(input_cds.MkP))
row.names(tsne_coords.MkP) <- row.names(pData(input_cds.MkP))

#Make cicero cds
#cicero_cds.FL <- make_cicero_cds(input_cds.FL, reduced_coordinates = umap_coords.FL)
#cicero_cds.CD41neg <- make_cicero_cds(input_cds.CD41neg, reduced_coordinates = umap_coords.CD41neg)
#cicero_cds.CD41pos <- make_cicero_cds(input_cds.CD41pos, reduced_coordinates = umap_coords.CD41pos)
#cicero_cds.MkP <- make_cicero_cds(input_cds.MkP, reduced_coordinates = umap_coords.MkP)

#Make cicero cds with tsn-ccord
cicero_cds.FL <- make_cicero_cds(input_cds.FL, reduced_coordinates = tsne_coords.FL)
cicero_cds.CD41neg <- make_cicero_cds(input_cds.CD41neg, reduced_coordinates = tsne_coords.CD41neg)
cicero_cds.CD41pos <- make_cicero_cds(input_cds.CD41pos, reduced_coordinates = tsne_coords.CD41pos)
cicero_cds.MkP <- make_cicero_cds(input_cds.MkP, reduced_coordinates = tsne_coords.MkP)


#Derive connections for each sample.
library(GenomicFeatures)
mouse.mm10.genome <- getChromInfoFromUCSC("mm10")
mouse.mm10.genome <- mouse.mm10.genome[1:22,]

conns.FL <- run_cicero(cicero_cds.FL, mouse.mm10.genome)
conns.FL <- subset(conns.FL, conns.FL$coaccess > 0)

conns.CD41neg <- run_cicero(cicero_cds.CD41neg, mouse.mm10.genome)
conns.CD41neg <- subset(conns.CD41neg, conns.CD41neg$coaccess > 0)

conns.CD41pos <- run_cicero(cicero_cds.CD41pos, mouse.mm10.genome)
conns.CD41pos <- subset(conns.CD41pos, conns.CD41pos$coaccess > 0)

conns.MkP <- run_cicero(cicero_cds.MkP, mouse.mm10.genome)
conns.MkP <- subset(conns.MkP, conns.MkP$coaccess > 0)

#conns.FL_backup <- conns.FL
#conns.CD41neg_backup <- conns.CD41neg
#conns.CD41pos_backup <- conns.CD41pos
#conns.MkP_backup <- conns.MkP

save.image("/mnt/data/common/jonas/scatac/191204_yuan_FLvsBM_HSC_BHHTF7DRXX/snap_atac_analysis/base_analysis_downscaled/monocle_coaccess_analysis.RData")

conns.FL <- conns.FL_backup
conns.CD41neg <- conns.CD41neg_backup
conns.CD41pos <- conns.CD41pos_backup
conns.MkP <- conns.MkP_backup

CCAN_assigns <- generate_ccans(conns.FL) # 0.14
CCAN_assigns <- generate_ccans(conns.CD41neg) # 0.18
CCAN_assigns <- generate_ccans(conns.CD41pos) # 0.25
CCAN_assigns <- generate_ccans(conns.MkP) # 0.32


#Calcluate thresholds.
#Apply filter
conns.FL <- subset(conns.FL, conns.FL$coaccess >= 0.14)
conns.CD41neg <- subset(conns.CD41neg, conns.CD41neg$coaccess >= 0.18)
conns.CD41pos <- subset(conns.CD41pos, conns.CD41pos$coaccess >= 0.25)
conns.MkP <- subset(conns.MkP, conns.MkP$coaccess >= 0.32)

#Annotate
temp <- tempfile()
download.file("ftp://ftp.ensembl.org/pub/release-99/gtf/mus_musculus/Mus_musculus.GRCm38.99.gtf.gz", temp)
gene_anno <- rtracklayer::readGFF(temp)
unlink(temp)

# rename some columns to match requirements
gene_anno$chromosome <- paste0("chr", gene_anno$seqid)
gene_anno$gene <- gene_anno$gene_id
gene_anno$transcript <- gene_anno$transcript_id
gene_anno$symbol <- gene_anno$gene_name
#### Add a column for the pData table indicating the gene if a peak is a promoter ####
# Create a gene annotation set that only marks the transcription start sites of 
# the genes. We use this as a proxy for promoters.
# To do this we need the first exon of each transcript
pos <- subset(gene_anno, strand == "+")
pos <- pos[order(pos$start),] 
# remove all but the first exons per transcript
pos <- pos[!duplicated(pos$transcript),] 
# make a 1 base pair marker of the TSS
pos$end <- pos$start + 1 

neg <- subset(gene_anno, strand == "-")
neg <- neg[order(neg$start, decreasing = TRUE),] 
# remove all but the first exons per transcript
neg <- neg[!duplicated(neg$transcript),] 
neg$start <- neg$end - 1

gene_annotation_sub <- rbind(pos, neg)
gene_annotation_sub <- gene_annotation_sub[,c("chromosome", "start", "end", "symbol")]

# Rename the gene symbol column to "gene"
names(gene_annotation_sub)[4] <- "gene"

input_cds.FL <- annotate_cds_by_site(input_cds.FL, gene_annotation_sub)
input_cds.CD41neg <- annotate_cds_by_site(input_cds.CD41neg, gene_annotation_sub)
input_cds.CD41pos <- annotate_cds_by_site(input_cds.CD41pos, gene_annotation_sub)
input_cds.MkP <- annotate_cds_by_site(input_cds.MkP , gene_annotation_sub)

#Bring out the annotated peaks.
cicero_peaks.FL <- as.data.frame(fData(input_cds.FL))
cicero_peaks.CD41neg <- as.data.frame(fData(input_cds.CD41neg))
cicero_peaks.CD41pos <- as.data.frame(fData(input_cds.CD41pos))
cicero_peaks.MkP <- as.data.frame(fData(input_cds.MkP))

cicero_peaks.FL <- cicero_peaks.FL[complete.cases(cicero_peaks.FL), ]
cicero_peaks.CD41neg <- cicero_peaks.CD41neg[complete.cases(cicero_peaks.CD41neg), ]
cicero_peaks.CD41pos <- cicero_peaks.CD41pos[complete.cases(cicero_peaks.CD41pos), ]
cicero_peaks.MkP <- cicero_peaks.MkP[complete.cases(cicero_peaks.MkP), ]


source("/home/jonas/R_scripts/match_list_function.R")
conns_filt.FL <- match_lists(conns.FL, conns.FL$Peak1, cicero_peaks.FL$site_name, 1, name_match_column = "ap1")
conns_filt.FL <- match_lists(conns_filt.FL, conns_filt.FL$Peak2, cicero_peaks.FL$site_name, 1, name_match_column = "ap2")
conns_filt.FL <- merge(conns_filt.FL, cicero_peaks.FL, by.x = "Peak1", by.y = "site_name", all.x = T)
conns_filt.FL <- conns_filt.FL[,c(1:5,11)]
conns_filt.FL <- merge(conns_filt.FL, cicero_peaks.FL, by.x = "Peak2", by.y = "site_name", all.x = T)
conns_filt.FL <- conns_filt.FL[,c(1:6,12)]
colnames(conns_filt.FL)[6] <- "TSS_1"
colnames(conns_filt.FL)[7] <- "TSS_2"


conns_filt.CD41neg <- match_lists(conns.CD41neg, conns.CD41neg$Peak1, cicero_peaks.CD41neg$site_name, 1, name_match_column = "ap1")
conns_filt.CD41neg <- match_lists(conns_filt.CD41neg, conns_filt.CD41neg$Peak2, cicero_peaks.CD41neg$site_name, 1, name_match_column = "ap2")
conns_filt.CD41neg <- merge(conns_filt.CD41neg, cicero_peaks.CD41neg, by.x = "Peak1", by.y = "site_name", all.x = T)
conns_filt.CD41neg <- conns_filt.CD41neg[,c(1:5,11)]
conns_filt.CD41neg <- merge(conns_filt.CD41neg, cicero_peaks.CD41neg, by.x = "Peak2", by.y = "site_name", all.x = T)
conns_filt.CD41neg <- conns_filt.CD41neg[,c(1:6,12)]
colnames(conns_filt.CD41neg)[6] <- "TSS_1"
colnames(conns_filt.CD41neg)[7] <- "TSS_2"

conns_filt.CD41pos <- match_lists(conns.CD41pos, conns.CD41pos$Peak1, cicero_peaks.CD41pos$site_name, 1, name_match_column = "ap1")
conns_filt.CD41pos <- match_lists(conns_filt.CD41pos, conns_filt.CD41pos$Peak2, cicero_peaks.CD41pos$site_name, 1, name_match_column = "ap2")
conns_filt.CD41pos <- merge(conns_filt.CD41pos, cicero_peaks.CD41pos, by.x = "Peak1", by.y = "site_name", all.x = T)
conns_filt.CD41pos <- conns_filt.CD41pos[,c(1:5,11)]
conns_filt.CD41pos <- merge(conns_filt.CD41pos, cicero_peaks.CD41pos, by.x = "Peak2", by.y = "site_name", all.x = T)
conns_filt.CD41pos <- conns_filt.CD41pos[,c(1:6,12)]
colnames(conns_filt.CD41pos)[6] <- "TSS_1"
colnames(conns_filt.CD41pos)[7] <- "TSS_2"

conns_filt.MkP <- match_lists(conns.MkP, conns.MkP$Peak1, cicero_peaks.MkP$site_name, 1, name_match_column = "ap1")
conns_filt.MkP <- match_lists(conns_filt.MkP, conns_filt.MkP$Peak2, cicero_peaks.MkP$site_name, 1, name_match_column = "ap2")
conns_filt.MkP <- merge(conns_filt.MkP, cicero_peaks.MkP, by.x = "Peak1", by.y = "site_name", all.x = T)
conns_filt.MkP <- conns_filt.MkP[,c(1:5,11)]
conns_filt.MkP <- merge(conns_filt.MkP, cicero_peaks.MkP, by.x = "Peak2", by.y = "site_name", all.x = T)
conns_filt.MkP <- conns_filt.MkP[,c(1:6,12)]
colnames(conns_filt.MkP)[6] <- "TSS_1"
colnames(conns_filt.MkP)[7] <- "TSS_2"


#Do this for the cell types one by one
conns_filt.FL <- match_lists(conns_filt.FL, conns_filt.FL$TSS_1, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_1")
conns_filt.FL <- match_lists(conns_filt.FL, conns_filt.FL$TSS_2, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_2")
conns_filt_fluidigm.FL <- subset(conns_filt.FL, conns_filt.FL$fluidigm_gene_1==1|conns_filt.FL$fluidigm_gene_2==1)

conns_filt.CD41neg <- match_lists(conns_filt.CD41neg, conns_filt.CD41neg$TSS_1, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_1")
conns_filt.CD41neg <- match_lists(conns_filt.CD41neg, conns_filt.CD41neg$TSS_2, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_2")
conns_filt_fluidigm.CD41neg <- subset(conns_filt.CD41neg, conns_filt.CD41neg$fluidigm_gene_1==1|conns_filt.CD41neg$fluidigm_gene_2==1)

conns_filt.CD41pos <- match_lists(conns_filt.CD41pos, conns_filt.CD41pos$TSS_1, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_1")
conns_filt.CD41pos <- match_lists(conns_filt.CD41pos, conns_filt.CD41pos$TSS_2, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_2")
conns_filt_fluidigm.CD41pos <- subset(conns_filt.CD41pos, conns_filt.CD41pos$fluidigm_gene_1==1|conns_filt.CD41pos$fluidigm_gene_2==1)

conns_filt.MkP <- match_lists(conns_filt.MkP, conns_filt.MkP$TSS_1, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_1")
conns_filt.MkP <- match_lists(conns_filt.MkP, conns_filt.MkP$TSS_2, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_2")
conns_filt_fluidigm.MkP <- subset(conns_filt.MkP, conns_filt.MkP$fluidigm_gene_1==1|conns_filt.MkP$fluidigm_gene_2==1)

#Combined to one df.
conns_filt_fluidigm <- rbind(conns_filt_fluidigm.FL, conns_filt_fluidigm.CD41neg, conns_filt_fluidigm.CD41pos, conns_filt_fluidigm.MkP)


peak1 <- cbind( as.data.frame(conns_filt_fluidigm[which(conns_filt_fluidigm$TSS_2 > 0),2]),as.data.frame(conns_filt_fluidigm[which(conns_filt_fluidigm$TSS_2 > 0),7]))
colnames(peak1) <- c("coord", "gene")

peak2 <- cbind( as.data.frame(conns_filt_fluidigm[which(conns_filt_fluidigm$TSS_1 > 0),1]),as.data.frame(conns_filt_fluidigm[which(conns_filt_fluidigm$TSS_1 > 0),6]))
colnames(peak2) <- c("coord", "gene")

int_conns_filt_fluidigm <- rbind(peak1,peak2)
int_conns_filt_fluidigm$gene <- as.character(int_conns_filt_fluidigm$gene)
library(stringr)
s <- str_split_fixed(int_conns_filt_fluidigm$coord, "_",3)
int_conns_filt_fluidigm <- cbind(as.data.frame(s[,1]),as.data.frame(s[,2]),as.data.frame(s[,3]), int_conns_filt_fluidigm$gene )

library(GenomicRanges)
int_conns_filt_fluidigm.gr = GRanges(as.character(int_conns_filt_fluidigm[,1]),  IRanges(as.numeric(as.character(int_conns_filt_fluidigm[,2])), as.numeric(as.character(int_conns_filt_fluidigm[,3]))), name=as.character(int_conns_filt_fluidigm[,4]))

marker.genes = as.vector(fluidigm_genes[,1])
#Reduce the GRanges data set to non-overlapping:
int_conns_filt_fluidigm.gr <- unlist(reduce(split(int_conns_filt_fluidigm.gr, int_conns_filt_fluidigm.gr$name)))
library(FusionExpressionPlot)
#Add back the name column.
int_conns_filt_fluidigm.gr <- grAddColumn(int_conns_filt_fluidigm.gr, name = "name", vec = names(int_conns_filt_fluidigm.gr))

test2 <- regions_to_av_access(marker.genes = marker.genes, full_peak_set=peak.gr, peak_mat=x.sp3.monocle@pmat , grange_obj = int_conns_filt_fluidigm.gr)                                     
fluidigm_gene_enhancer_score_df_2 <- do.call(rbind, test2[[1]])                                    
View(fluidigm_gene_enhancer_score_df_2)


write.table(fluidigm_gene_enhancer_score_df_2, "fluidigm_gene_enhancer_score_df.individual_peaks_coaccess_10.txt", sep = "\t", quote = ```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:
```
  
```{r all_cicero_conn, include=FALSE}
############As one sample here
library(cicero)
library(GenomicRanges)
peak.matrix <- t (as(object = x.sp3.monocle@pmat, Class = 'matrix') )
colnames(peak.matrix) <- x.sp3.monocle@sample
peaks.df <- as.data.frame(peak.gr)[,1:3]
rownames(peak.matrix) <- paste(peaks.df[,1],peaks.df[,2],peaks.df[,3],sep = "_")

library(reshape2)
peaks.df <- as.data.frame( peak.matrix )
#table(colnames(peaks.df))
#CD41neg CD41pos  FL_HSC     MkP 
#   2310    1123    2403    2986

                                  
colnames(peaks.df)[1:2403] <- paste(colnames(peaks.df)[1:2403], 1:2403, sep = "-")   
colnames(peaks.df)[2404:4713] <- paste(colnames(peaks.df)[2404:4713], 1:2310, sep = "-")
colnames(peaks.df)[4714:5836] <- paste(colnames(peaks.df)[4714:5836], 1:1123, sep = "-")
colnames(peaks.df)[5837:8822] <- paste(colnames(peaks.df)[5837:8822], 1:2986, sep = "-")

                                  
peaks.df$peaks <- rownames(peak.matrix) 
peaks.df <- melt(peaks.df, id.var = c("peaks"))

#Save only bigger than 0 columns
peaks.df <- subset(peaks.df, peaks.df$value > 0)

library(cicero)
input_cds <- make_atac_cds(peaks.df, binarize = TRUE)
umap_coords <- x.sp3.monocle@umap
rownames(umap_coords)<-colnames(input_cds)

#Calculate tsne
input_cds <- detectGenes(input_cds)
input_cds <- estimateSizeFactors(input_cds)
input_cds <- reduceDimension(input_cds, max_components = 2, num_dim=6,
                      reduction_method = 'tSNE', norm_method = "none")
tsne_coords <- t(reducedDimA(input_cds))
row.names(tsne_coords) <- row.names(pData(input_cds))

#cicero_cds <- make_cicero_cds(input_cds, reduced_coordinates = umap_coords)
cicero_cds <- make_cicero_cds(input_cds, reduced_coordinates = tsne_coords)


library(GenomicFeatures)
mouse.mm10.genome <- getChromInfoFromUCSC("mm10")
mouse.mm10.genome <- mouse.mm10.genome[1:22,]

conns <- run_cicero(cicero_cds, mouse.mm10.genome)
conns <- subset(conns, conns$coaccess > 0)

#conns.back_up <- conns 

conns <- conns.back_up

CCAN_assigns <- generate_ccans(conns) # 0.32
conns <- subset(conns, conns$coaccess >= 0.32)
#Gene activity score calculation:
#### Add a column for the pData table indicating the gene if a peak is a promoter ####
# Create a gene annotation set that only marks the transcription start sites of 
# the genes. We use this as a proxy for promoters.
# To do this we need the first exon of each transcript
pos <- subset(gene_anno, strand == "+")
pos <- pos[order(pos$start),] 
# remove all but the first exons per transcript
pos <- pos[!duplicated(pos$transcript),] 
# make a 1 base pair marker of the TSS
pos$end <- pos$start + 1 

neg <- subset(gene_anno, strand == "-")
neg <- neg[order(neg$start, decreasing = TRUE),] 
# remove all but the first exons per transcript
neg <- neg[!duplicated(neg$transcript),] 
neg$start <- neg$end - 1

gene_annotation_sub <- rbind(pos, neg)
gene_annotation_sub <- gene_annotation_sub[,c("chromosome", "start", "end", "symbol")]

# Rename the gene symbol column to "gene"
names(gene_annotation_sub)[4] <- "gene"

input_cds <- annotate_cds_by_site(input_cds, gene_annotation_sub)
#Bring out the annotated peaks.
cicero_peaks <- as.data.frame(fData(input_cds))
cicero_peaks <-cicero_peaks[complete.cases(cicero_peaks), ]
save.image("/mnt/data/common/jonas/scatac/191204_yuan_FLvsBM_HSC_BHHTF7DRXX/snap_atac_analysis/base_analysis_downscaled/monocle_coaccess_analysis.RData")
######################

conns_filt <- match_lists(conns, conns$Peak1, cicero_peaks$site_name, 1, name_match_column = "ap1")
conns_filt <- match_lists(conns_filt, conns_filt$Peak2, cicero_peaks$site_name, 1, name_match_column = "ap2")
conns_filt <- merge(conns_filt, cicero_peaks, by.x = "Peak1", by.y = "site_name", all.x = T)
conns_filt <- conns_filt[,c(1:5,11)]
conns_filt <- merge(conns_filt, cicero_peaks, by.x = "Peak2", by.y = "site_name", all.x = T)
conns_filt <- conns_filt[,c(1:6,12)]
colnames(conns_filt)[6] <- "TSS_1"
colnames(conns_filt)[7] <- "TSS_2"

conns_filt <- match_lists(conns_filt, conns_filt$TSS_1, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_1")
conns_filt <- match_lists(conns_filt, conns_filt$TSS_2, fluidigm_genes$V1, 1, name_match_column = "fluidigm_gene_2")
conns_filt_fluidigm <- subset(conns_filt, conns_filt$fluidigm_gene_1==1|conns_filt$fluidigm_gene_2==1)

peak1 <- cbind( as.data.frame(conns_filt_fluidigm[which(conns_filt_fluidigm$TSS_2 > 0),2]),as.data.frame(conns_filt_fluidigm[which(conns_filt_fluidigm$TSS_2 > 0),7]))
colnames(peak1) <- c("coord", "gene")

peak2 <- cbind( as.data.frame(conns_filt_fluidigm[which(conns_filt_fluidigm$TSS_1 > 0),1]),as.data.frame(conns_filt_fluidigm[which(conns_filt_fluidigm$TSS_1 > 0),6]))
colnames(peak2) <- c("coord", "gene")

int_conns_filt_fluidigm <- rbind(peak1,peak2)
int_conns_filt_fluidigm$gene <- as.character(int_conns_filt_fluidigm$gene)
library(stringr)
s <- str_split_fixed(int_conns_filt_fluidigm$coord, "_",3)
int_conns_filt_fluidigm <- cbind(as.data.frame(s[,1]),as.data.frame(s[,2]),as.data.frame(s[,3]), int_conns_filt_fluidigm$gene )

library(GenomicRanges)
int_conns_filt_fluidigm.gr = GRanges(as.character(int_conns_filt_fluidigm[,1]),  IRanges(as.numeric(as.character(int_conns_filt_fluidigm[,2])), as.numeric(as.character(int_conns_filt_fluidigm[,3]))), name=as.character(int_conns_filt_fluidigm[,4]))

#Reduce the GRanges data set to non-overlapping:
int_conns_filt_fluidigm.gr <- unlist(reduce(split(int_conns_filt_fluidigm.gr, int_conns_filt_fluidigm.gr$name)))

library(FusionExpressionPlot)
#Add back the name column.
int_conns_filt_fluidigm.gr <- grAddColumn(int_conns_filt_fluidigm.gr, name = "name", vec = names(int_conns_filt_fluidigm.gr))

fluidigm_gene_enhancer_score_combined_peaks <- regions_to_av_access(marker.genes = marker.genes, full_peak_set=peak.gr, peak_mat=x.sp3.monocle@pmat , grange_obj = int_conns_filt_fluidigm.gr)   

fluidigm_gene_enhancer_score_df <- do.call(rbind, fluidigm_gene_enhancer_score_combined_peaks[[1]]) 

save.image("/mnt/data/common/jonas/scatac/191204_yuan_FLvsBM_HSC_BHHTF7DRXX/snap_atac_analysis/base_analysis_downscaled/monocle_coaccess_analysis.RData")

View(fluidigm_gene_enhancer_score_df)

#write.table(fluidigm_gene_enhancer_score_df, "fluidigm_gene_enhancer_score_df.combined_peaks_coaccess_0.32.txt", sep = "\t", quote = F)
write.table(fluidigm_gene_enhancer_score_df, "fluidigm_gene_enhancer_score_df.combined_peaks_coaccess_0.32.txt", sep = "\t", quote = F)

test <- unlist(fluidigm_gene_enhancer_score_combined_peaks[[2]])
lapply(test, annoGR2DF)
```

## Including Plots

You can also embed plots, for example:

```{r make_tracks_from_conns_filt, include=FALSE}

#Only keep conns filt where there is a TSS
conns_filt.TSS <- subset(conns_filt, conns_filt$TSS_1 > 0 | conns_filt$TSS_2 > 0)

#Remove double scores that I am fairly sure are the same interactions.
conns_filt.TSS <- conns_filt.TSS[!duplicated(conns_filt.TSS$coaccess), ]

library(stringr)
s <- str_split_fixed(conns_filt.TSS$Peak1, "_",3)
int_conns_filt.TSS_1<- cbind(as.data.frame(s[,1]),as.data.frame(s[,2]),as.data.frame(s[,3]) )

s <- str_split_fixed(conns_filt.TSS$Peak2, "_",3)
int_conns_filt.TSS_2<- cbind(as.data.frame(s[,1]),as.data.frame(s[,2]),as.data.frame(s[,3]), conns_filt.TSS$coaccess )

int_conns_filt.TSS <- cbind(int_conns_filt.TSS_1, int_conns_filt.TSS_2)

write.table(int_conns_filt.TSS, "int_conns_filt.TSS.bed", row.names = F, col.names = F, quote = F, sep = "\t")

#Only keep conns filt where there is a TSS

library(stringr)
s <- str_split_fixed(conns_filt_fluidigm$Peak1, "_",3)
int_conns_filt_fluidigm.TSS_1<- cbind(as.data.frame(s[,1]),as.data.frame(s[,2]),as.data.frame(s[,3]) )

s <- str_split_fixed(conns_filt_fluidigm$Peak2, "_",3)
int_conns_filt_fluidigm.TSS_2<- cbind(as.data.frame(s[,1]),as.data.frame(s[,2]),as.data.frame(s[,3]), conns_filt_fluidigm$coaccess )

int_conns_filt_fluidigm.TSS <- cbind(int_conns_filt_fluidigm.TSS_1, int_conns_filt_fluidigm.TSS_2)

write.table(int_conns_filt_fluidigm.TSS, "int_conns_filt_fluidigm.TSS.bed", row.names = F, col.names = F, quote = F, sep = "\t")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
